<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: git | Yongbing's Blog]]></title>
  <link href="http://yongbingchen.github.com/blog/categories/git/atom.xml" rel="self"/>
  <link href="http://yongbingchen.github.com/"/>
  <updated>2015-03-27T22:06:54-07:00</updated>
  <id>http://yongbingchen.github.com/</id>
  <author>
    <name><![CDATA[Yongbing Chen]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[config gerrit server behind Apache https reverse-proxy]]></title>
    <link href="http://yongbingchen.github.com/blog/2015/03/27/config-gerrit-server-behind-apache-https-reverse-proxy/"/>
    <updated>2015-03-27T16:20:00-07:00</updated>
    <id>http://yongbingchen.github.com/blog/2015/03/27/config-gerrit-server-behind-apache-https-reverse-proxy</id>
    <content type="html"><![CDATA[<p>I want to setup a secure gerrit server for a small developer group within intranet, I choose Apache as its reverse-proxy server, and use HTTP as gerrit server's auth type, becasue I only want a few selected people to see the server, so no LDAP.</p>

<p>Here's the final web view from a registered developer:
<img src="http://yongbingchen.github.com/images/git/repo/sample-cl-webpage.jpg" title="" ></p>

<p>Here's the gerrit server config:
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[gerrit]&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>basePath = git
</span><span class='line'>canonicalWebUrl = https://gerritreview.com/gerrit
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>[database]&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>type = mysql
</span><span class='line'>hostname = localhost
</span><span class='line'>database = reviewdb
</span><span class='line'>username = gerrit2
</span><span class='line'>password = 12345678
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>[auth]&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>type = HTTP
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>[sendemail]&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>smtpServer = localhost
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>[container]&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>user = gerrit2
</span><span class='line'>javaHome = /usr/lib/jvm/java-7-openjdk-amd64/jre
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>[sshd]&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>listenAddress = *:29418
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>[httpd]&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>listenUrl = proxy-https://localhost:8080/gerrit
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>[cache]&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>directory = cache
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>[index]&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>type = LUCENE
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>And the changes I made upon default Apache HTTPS site config:
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>--- /etc/apache2/sites-available/default-ssl.conf   2014-01-07 05:23:42.000000000 -0800
</span><span class='line'>+++ /etc/apache2/sites-available/000-default.conf   2015-03-25 14:41:20.867255345 -0700
</span><span class='line'>@@ -130,6 +130,71 @@&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>    # MSIE 7 and newer should be able to use keepalive
</span><span class='line'>    BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;ul>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        ServerName gerritreview.com
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        ProxyRequests Off
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        ProxyVia Off
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        ProxyPreserveHost On
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        &lt;Proxy *&gt;
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>                Order deny,allow
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>                Allow from all
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        &lt;/Proxy&gt;
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        &lt;Location /&gt;
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>                AuthType Basic
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>                AuthName "Gerrit Code Review"
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>                Require valid-user
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>                AuthBasicProvider file
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>                AuthUserFile /etc/apache2/passwords
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        &lt;/Location&gt;
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>+&lt;/p>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        AllowEncodedSlashes On
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        SSLProxyEngine On
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        SSLProxyVerify none
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        SSLProxyCheckPeerCN off
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        SSLProxyCheckPeerName off
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        ProxyPass /gerrit/ http://localhost:8080/gerrit/ nocanon
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        ProxyPassReverse /gerrit/ http://localhost:8080/gerrit/
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        # is this necessary?    
</span><span class='line'>&lt;/code>&lt;/pre>&lt;/li>
</span><span class='line'>&lt;li>&lt;pre>&lt;code>        Header edit Location "^http:(.*)$" "https:$1"
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>+
</span><span class='line'>&lt;/VirtualHost>
</span><span class='line'>&lt;/IfModule></span></code></pre></td></tr></table></div></figure></notextile></div></p></li>
</ul>


<p>After setup, this gerrit server was deployed in a kvm guest machine, connected to its kvm host through an isolated virtual bridge.  Allowing bidirectional access to tcp port 29418 (gerrit ssh), 443 (HTTPS), 25 (sendmail), as below command:
```sh</p>

<h1>forward kvm host's incoming (from NIC eth0) tcp dst port 29418 to gerrit server vm.</h1>

<p>iptables -I FORWARD -i eth0 -p tcp -m state --state NEW,RELATED,ESTABLISHED -m tcp -d $VM_GUEST_IP/32 -dport 29418 -j ACCEPT</p>

<h1>any incoming packets from interface eth0, protocol tcp, dst port 29418 will be applied DNAT function (replace the dst addr from kvm host to $VM_GUEST_IP)</h1>

<p>iptables -t nat -i eth0 -I PREROUTING -p tcp  --dport 29418 -j DNAT --to $VM_GUEST_IP:29418</p>

<h1>replace any outboud tcp/29418 packet from $VM_GUEST_IP with kvm host's addr, and push to host's NIC eth0</h1>

<p>iptables -t nat -A POSTROUTING -p tcp -o eth0 -s $VM_GUEST_IP --sport 29418 -j MASQUERADE</p>

<h1>forward outgoing tcp/29418 connect from $VM_GUEST_IP to host's NIC eth0</h1>

<p>iptables -I FORWARD -o eth0 -p tcp -m state --state NEW,RELATED,ESTABLISHED -m tcp -s $VM_GUEST_IP --sport 29418 -j ACCEPT
```</p>

<p>Also NAT rules to allow connection from the vm guest (gerrit server) to connect to a NTP server:
<code>sh
iptables -t nat -A POSTROUTING -p udp -s $VM_GUEST_IP/32 -d 174.137.132.100 -dport 123 -j MASQUERADE
iptables -I FORWARD -p udp -s $VM_GUEST_IP/32 -d 174.137.132.100/32 -dport 123 -j ACCEPT
iptables -I FORWARD -p udp -d $VM_GUEST_IP/32 -s 174.137.132.100/32 -dport 123 -j ACCEPT
</code></p>

<h2>Notes:</h2>

<p><blockquote><p></p><footer><strong>Installation and config note</strong> <cite><a href='http://yongbingchen.github.com/txt/gerrit/install-and-maintain.txt'>yongbingchen.github.com/txt/&hellip;</a></cite></footer></blockquote>
<blockquote><p></p><footer><strong>Full Apache HTTPS site config</strong> <cite><a href='http://yongbingchen.github.com/txt/gerrit/000-default.conf'>yongbingchen.github.com/txt/&hellip;</a></cite></footer></blockquote></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[git: check ancestor]]></title>
    <link href="http://yongbingchen.github.com/blog/2013/03/25/git-check-ancestor/"/>
    <updated>2013-03-25T22:59:00-07:00</updated>
    <id>http://yongbingchen.github.com/blog/2013/03/25/git-check-ancestor</id>
    <content type="html"><![CDATA[<p>If you want to check your code base, it's wrong to rely on whether the output of <code>git log $CODE_BASE_TAG..HEAD</code> is empty.</p>

<p>Suppose we have a git version tree as below:</p>

<p><img src="http://yongbingchen.github.com/images/git/version-graph.jpg" title="" ></p>

<p>DevBranch0 is branched out from Trunk, merged <code>Trunk</code> node C and <code>DevBranch0</code> node b, current HEAD is <code>DevBranch0_c</code>.</p>

<p>The git history is as below:
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yongbing@ubuntu:~/work/git_ancestor$ git log --oneline --graph
</span><span class='line'>* 368cfb1 DevBranch0_c
</span><span class='line'>*   6fecd0a DevBranch0_Merge
</span><span class='line'>|\
</span><span class='line'>| * defff5c Trunk_C
</span><span class='line'>| * 5037bca Trunk_B
</span><span class='line'>* | 0f45ab0 DevBranch0_b
</span><span class='line'>* | 38f9ec9 DevBranch0_a
</span><span class='line'>|/
</span><span class='line'>* fc18378 Trunk_A
</span><span class='line'>* 0d3b0bd Init state</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Clearly version <code>Trunk_D</code> is not an ancestor of <code>DevBranch0_c</code>, but <code>git log $Trunk_D..HEAD</code> is not empty:
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yongbing@ubuntu:~/work/git_ancestor$ git tag Trunk_D b25477d
</span><span class='line'>yongbing@ubuntu:~/work/git_ancestor$ git log Trunk_D..HEAD --oneline
</span><span class='line'>368cfb1 DevBranch0_c
</span><span class='line'>6fecd0a DevBranch0_Merge
</span><span class='line'>0f45ab0 DevBranch0_b
</span><span class='line'>38f9ec9 DevBranch0_a</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>The correct way is to use <code>git rev-list</code> command, then grep the result to see if the code base in really in the ancestor list:
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yongbing@ubuntu:~/work/git_ancestor$ git log -g --oneline
</span><span class='line'>b25477d HEAD@{1}: commit: Trunk_D
</span><span class='line'>5037bca HEAD@{9}: commit: Trunk_B
</span><span class='line'>yongbing@ubuntu:~/work/git_ancestor$ git rev-list -n 10 HEAD |grep 5037bca
</span><span class='line'>5037bca575ecbf76d9c9d939e52f8858dbaadfe1
</span><span class='line'>yongbing@ubuntu:~/work/git_ancestor$ git rev-list -n 10 HEAD |grep b25477d
</span><span class='line'>//Empty output&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;p></span></code></pre></td></tr></table></div></figure></notextile></div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Loose coopling hierarchical gerrit workflow]]></title>
    <link href="http://yongbingchen.github.com/blog/2013/03/11/loose-coopling-hierarchical-gerrit-workflow/"/>
    <updated>2013-03-11T22:58:00-07:00</updated>
    <id>http://yongbingchen.github.com/blog/2013/03/11/loose-coopling-hierarchical-gerrit-workflow</id>
    <content type="html"><![CDATA[<p>As we are working on an Android project, we are handling a very large scale source tree (10GB level), including works from BSP team (bootloader, linux kernel), midware team (A/V codec, media framework),  and Android team (Android HAL, vendor specific Apks). We need to do weekly relaese for several products from single source tree, ensuring no quality degradation in the mean time.</p>

<p>A work flow serves these requirement needs to:</p>

<ol>
<li>have least cross team dependancy.</li>
<li>provide tight collaboration in developers.</li>
<li>easily locate bad node when doing release.</li>
</ol>


<p>To achive these requirements, I defined below branches:</p>

<ol>
<li>One trunk branch for releasing. Every node is a stable node (passed full test).</li>
<li>Every team has one independent developing branch, covering this team's source code partition, based on last release version, closed after current release is done.</li>
<li>Integration branch is based on last release version, will integrate above developing branches. Perform full test on this branch, cull out bad node when failed.</li>
</ol>


<p>And a workflow based on these branches:</p>

<ol>
<li>Every developer submits to developing branch (cross team submit is permitted), gerrit review process servers as first gate keeper in this stage. Add auto build, auto test in gerrit merge hook, let every commit has a build image, and this image will contain all its preceding commits, this makes possible of using binary search to cull out bad node in QA stage.</li>
<li>After submit window closed, integrators merge these developing branches into one integration branch, perform full test on the result, if failed, apply the failed case on all tail nodes of developing branches, this step picks out the failed developing branch. Then use binary search method on this developing branch to cull out the bad node, and update the developing branch. Iterate untill integration result pass full test.</li>
<li>Push the passed result into release branch, open submit window, start next developing/release cycle.</li>
</ol>


<p><em>Branches:</em>
<img src="http://yongbingchen.github.com/images/gerrit/branches.jpg" title="" ></p>
]]></content>
  </entry>
  
</feed>
