
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Yongbing's Blog</title>
  <meta name="author" content="Yongbing Chen">

  
  <meta name="description" content="Item A. Connect a remote A2DP device: 1 Android system will try to reconnect paired A2DP device automatically after BT enable. 1
2
3
4
5
6
7
8
9
04- &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yongbingchen.github.com/blog/page/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Yongbing's Blog" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39352307-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <div id="logo">
  	<div id="logoLeft"></div>
  	<div id="logoText"></div>
  	<div id="logoRight"></div>
  	<div class="clear"></div>
  </div>
  <h1><a href="/">Yongbing's Blog</a></h1>
  
    <h2>A personal technical note.</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:yongbingchen.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about-me">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/05/07/dissect-bluedroid-from-a2dp-part-iv-a2dp-traffic/">Dissect Bluedroid From A2DP: Part IV: Connect and Communication</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-05-07T04:50:00-07:00" pubdate data-updated="true">May 7<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/05/07/dissect-bluedroid-from-a2dp-part-iv-a2dp-traffic/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Item A. Connect a remote A2DP device:</h3>

<p><img class="center" src="http://yongbingchen.github.com/images/bluedroid/a2dp_connect.jpg" title="" >
1 Android system will try to reconnect paired A2DP device automatically after BT enable.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="mo">04</span><span class="o">-</span><span class="mi">25</span> <span class="mo">01</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mf">31.080</span> <span class="n">D</span><span class="o">/</span><span class="n">BluetoothAdapterService</span><span class="p">(</span> <span class="mi">2093</span><span class="p">)</span><span class="o">:</span> <span class="n">Auto</span> <span class="n">Connecting</span> <span class="n">A2DP</span> <span class="n">Profile</span> <span class="n">with</span> <span class="n">device</span> <span class="mi">50</span><span class="o">:</span><span class="nl">C9:</span><span class="mi">71</span><span class="o">:</span><span class="mi">0</span><span class="nl">D:D2:</span><span class="n">D9</span>
</span><span class='line'>  <span class="n">packages</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">Bluetooth</span><span class="o">/</span><span class="n">jni</span><span class="o">/</span><span class="n">com_android_bluetooth_a2dp</span><span class="p">.</span><span class="n">cpp</span> 
</span><span class='line'>  <span class="k">static</span> <span class="n">jboolean</span> <span class="n">connectA2dpNative</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">object</span><span class="p">,</span> <span class="n">jbyteArray</span> <span class="n">address</span><span class="p">)</span>
</span><span class='line'>      <span class="k">const</span> <span class="n">bt_interface_t</span><span class="o">*</span> <span class="n">btInf</span><span class="o">=</span> <span class="n">getBluetoothInterface</span><span class="p">();</span>
</span><span class='line'>      <span class="k">const</span> <span class="n">btav_interface_t</span> <span class="o">*</span><span class="n">sBluetoothA2dpInterface</span> <span class="o">=</span> <span class="p">(</span><span class="n">btav_interface_t</span> <span class="o">*</span><span class="p">)</span><span class="n">btInf</span><span class="o">-&gt;</span><span class="n">get_profile_interface</span><span class="p">(</span><span class="n">BT_PROFILE_ADVANCED_AUDIO_ID</span><span class="p">);</span>
</span><span class='line'>      <span class="n">status</span> <span class="o">=</span> <span class="n">sBluetoothA2dpInterface</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">((</span><span class="n">bt_bdaddr_t</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">)</span>
</span><span class='line'>          <span class="n">external</span><span class="o">/</span><span class="n">bluetooth</span><span class="o">/</span><span class="n">bluedroid</span><span class="o">/</span><span class="n">btif</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">btif_av</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'>          <span class="n">btif_queue_connect</span><span class="p">(</span><span class="n">UUID_SERVCLASS_AUDIO_SOURCE</span><span class="p">,</span> <span class="n">bd_addr</span><span class="p">,</span> <span class="n">connect_int</span><span class="p">);</span><span class="c1">//This will trigger an event in btu_task, now the caller thread returned.</span>
</span><span class='line'>              <span class="n">GKI_send_msg</span><span class="p">(</span><span class="n">BTIF_TASK</span><span class="p">,</span> <span class="n">BTU_BTIF_MBOX</span><span class="p">,</span> <span class="n">p_msg</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>2 This will later trigger a A2DP server event API_CONNECT_REQ_EVT in state CCB_IDLE_ST:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="mo">05</span><span class="o">-</span><span class="mo">02</span> <span class="mo">01</span><span class="o">:</span><span class="mi">54</span><span class="o">:</span><span class="mf">33.342</span> <span class="n">I</span><span class="o">/</span><span class="n">bt</span><span class="o">-</span><span class="n">avp</span>  <span class="p">(</span> <span class="mi">2093</span><span class="p">)</span><span class="o">:</span> <span class="n">CCB</span> <span class="n">ccb</span><span class="o">=</span><span class="mi">0</span> <span class="n">event</span><span class="o">=</span><span class="n">API_CONNECT_REQ_EVT</span> <span class="n">state</span><span class="o">=</span><span class="n">CCB_IDLE_ST</span>
</span></code></pre></td></tr></table></div></figure>


<p>3 A2DP server handle this event in bellow two actions:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">external</span><span class="o">/</span><span class="n">bluetooth</span><span class="o">/</span><span class="n">bluedroid</span><span class="o">/</span><span class="n">stack</span><span class="o">/</span><span class="n">avdt</span><span class="o">/</span><span class="n">avdt_ccb</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'><span class="mi">129</span> <span class="k">const</span> <span class="n">UINT8</span> <span class="n">avdt_ccb_st_idle</span><span class="p">[][</span><span class="n">AVDT_CCB_NUM_COLS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'><span class="mi">130</span> <span class="cm">/* Event                      Action 1                    Action 2                    Next state */</span>
</span><span class='line'><span class="mi">139</span> <span class="cm">/* API_CONNECT_REQ_EVT */</span>    <span class="p">{</span><span class="n">AVDT_CCB_SET_CONN</span><span class="p">,</span>          <span class="n">AVDT_CCB_CHAN_OPEN</span><span class="p">,</span>         <span class="n">AVDT_CCB_OPENING_ST</span><span class="p">},</span>
</span><span class='line'><span class="c1">//3.1 Set CCB variables associated with AVDT_ConnectReq().</span>
</span><span class='line'><span class="mi">996</span> <span class="kt">void</span> <span class="n">avdt_ccb_set_conn</span><span class="p">(</span><span class="n">tAVDT_CCB</span> <span class="o">*</span><span class="n">p_ccb</span><span class="p">,</span> <span class="n">tAVDT_CCB_EVT</span> <span class="o">*</span><span class="n">p_data</span><span class="p">)</span>
</span><span class='line'>  <span class="n">BTM_SetSecurityLevel</span><span class="p">(</span><span class="n">TRUE</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">BTM_SEC_SERVICE_AVDTP</span><span class="p">,</span> <span class="n">p_data</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">.</span><span class="n">sec_mask</span><span class="p">,</span><span class="n">AVDT_PSM</span><span class="p">,</span> <span class="n">BTM_SEC_PROTO_AVDT</span><span class="p">,</span> <span class="n">AVDT_CHAN_SIG</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//3.2 initiate a signaling channel connection.</span>
</span><span class='line'><span class="mi">87</span> <span class="kt">void</span> <span class="n">avdt_ccb_chan_open</span><span class="p">(</span><span class="n">tAVDT_CCB</span> <span class="o">*</span><span class="n">p_ccb</span><span class="p">,</span> <span class="n">tAVDT_CCB_EVT</span> <span class="o">*</span><span class="n">p_data</span><span class="p">)</span>
</span><span class='line'>                  <span class="n">BTM_SetOutService</span><span class="p">(</span><span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">,</span> <span class="n">BTM_SEC_SERVICE_AVDTP</span><span class="p">,</span> <span class="n">AVDT_CHAN_SIG</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">avdt_ad_open_req</span><span class="p">(</span><span class="n">AVDT_CHAN_SIG</span><span class="p">,</span> <span class="n">p_ccb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">AVDT_INT</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>4 How L2CAP handle this channel connection:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">external</span><span class="o">/</span><span class="n">bluetooth</span><span class="o">/</span><span class="n">bluedroid</span><span class="o">/</span><span class="n">stack</span><span class="o">/</span><span class="n">l2cap</span><span class="o">/</span><span class="n">l2c_api</span><span class="p">.</span><span class="n">c</span>                     
</span><span class='line'><span class="mi">229</span> <span class="n">UINT16</span> <span class="n">L2CA_ErtmConnectReq</span> <span class="p">(</span><span class="n">UINT16</span> <span class="n">psm</span><span class="p">,</span> <span class="n">BD_ADDR</span> <span class="n">p_bd_addr</span><span class="p">,</span> <span class="n">tL2CAP_ERTM_INFO</span> <span class="o">*</span><span class="n">p_ertm_info</span><span class="p">)</span>                      
</span><span class='line'>  <span class="n">p_lcb</span> <span class="o">=</span> <span class="n">l2cu_allocate_lcb</span> <span class="p">(</span><span class="n">p_bd_addr</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
</span><span class='line'>  <span class="n">l2cu_create_conn</span><span class="p">(</span><span class="n">p_lcb</span><span class="p">);</span><span class="c1">//This function initiates an acl connection via HCI</span>
</span><span class='line'>      <span class="mi">2180</span> <span class="n">BOOLEAN</span> <span class="n">l2cu_create_conn_after_switch</span> <span class="p">(</span><span class="n">tL2C_LCB</span> <span class="o">*</span><span class="n">p_lcb</span><span class="p">)</span>
</span><span class='line'>          <span class="c1">//external/bluetooth/bluedroid/stack/hcic/hcicmds.c</span>
</span><span class='line'>          <span class="n">btsnd_hcic_create_conn</span> <span class="p">(</span><span class="n">p_lcb</span><span class="o">-&gt;</span><span class="n">remote_bd_addr</span><span class="p">,</span><span class="n">HCI_PKT_TYPES_MASK_DM1</span> <span class="o">+</span> <span class="n">HCI_PKT_TYPES_MASK_DH1</span><span class="p">,</span><span class="n">page_scan_rep_mode</span><span class="p">,</span><span class="n">page_scan_mode</span><span class="p">,</span><span class="n">clock_offset</span><span class="p">,</span><span class="n">allow_switch</span><span class="p">));</span>
</span><span class='line'>              <span class="n">HCI_CMD_TO_LOWER</span><span class="p">(</span><span class="n">p_buf</span><span class="p">);</span>
</span><span class='line'>                  <span class="c1">//external/bluetooth/bluedroid/main/bte_main.c</span>
</span><span class='line'>                  <span class="n">bt_hc_if</span><span class="o">-&gt;</span><span class="n">transmit_buf</span><span class="p">((</span><span class="n">TRANSAC</span><span class="p">)</span><span class="n">p_msg</span><span class="p">,</span> <span class="err">\</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p_msg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="err">\</span><span class="n">p_msg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">utils_enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_q</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">transac</span><span class="p">);</span>
</span><span class='line'>                       <span class="n">bthc_signal_event</span><span class="p">(</span><span class="n">HC_EVENT_TX</span><span class="p">);</span>
</span><span class='line'>          <span class="n">btu_start_timer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">p_lcb</span><span class="o">-&gt;</span><span class="n">timer_entry</span><span class="p">,</span> <span class="n">BTU_TTYPE_L2CAP_LINK</span><span class="p">,</span><span class="n">L2CAP_LINK_CONNECT_TOUT</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>5 This command will trigger connection establish process between local and remote device, accomplished by a event-driven state machine in BT stack.</p>

<h3>Item B. a2dp_write data path:</h3>

<p><img class="center" src="http://yongbingchen.github.com/images/bluedroid/a2dp_write.jpg" title="" >
1 A2DP client writes to A2DP data socket will trigger API_WRITE_REQ_EVT in SCB_STREAM_ST state:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="mo">05</span><span class="o">-</span><span class="mo">02</span> <span class="mo">01</span><span class="o">:</span><span class="mi">14</span><span class="o">:</span><span class="mf">03.134</span> <span class="n">I</span><span class="o">/</span><span class="n">bt</span><span class="o">-</span><span class="n">avp</span>  <span class="p">(</span> <span class="mi">2139</span><span class="p">)</span><span class="o">:</span> <span class="n">SCB</span> <span class="n">hdl</span><span class="o">=</span><span class="mi">1</span> <span class="n">event</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">API_WRITE_REQ_EVT</span> <span class="n">state</span><span class="o">=</span><span class="n">SCB_STREAM_ST</span>
</span><span class='line'><span class="mi">394</span> <span class="cm">/* state table for streaming state */</span>
</span><span class='line'><span class="mi">395</span> <span class="k">const</span> <span class="n">UINT8</span> <span class="n">avdt_scb_st_stream</span><span class="p">[][</span><span class="n">AVDT_SCB_NUM_COLS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'><span class="mi">396</span> <span class="cm">/* Event                     Action 1                       Action 2                    Next state */</span>
</span><span class='line'><span class="mi">398</span> <span class="cm">/* API_WRITE_REQ_EVT */</span>     <span class="p">{</span><span class="n">AVDT_SCB_HDL_WRITE_REQ</span><span class="p">,</span>        <span class="n">AVDT_SCB_CHK_SND_PKT</span><span class="p">,</span>       <span class="n">AVDT_SCB_STREAM_ST</span><span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>2 A2DP server handle this with bellow two actions:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="c1">//2.1 build a new media packet and stores it in the SCB.</span>
</span><span class='line'><span class="n">external</span><span class="o">/</span><span class="n">bluetooth</span><span class="o">/</span><span class="n">bluedroid</span><span class="o">/</span><span class="n">stack</span><span class="o">/</span><span class="n">avdt</span><span class="o">/</span><span class="n">avdt_scb_act</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'><span class="mi">1320</span> <span class="kt">void</span> <span class="n">avdt_scb_hdl_write_req</span><span class="p">(</span><span class="n">tAVDT_SCB</span> <span class="o">*</span><span class="n">p_scb</span><span class="p">,</span> <span class="n">tAVDT_SCB_EVT</span> <span class="o">*</span><span class="n">p_data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//2.2 send this stored media packet to L2CAP layer.</span>
</span><span class='line'><span class="mi">1921</span> <span class="kt">void</span> <span class="n">avdt_scb_chk_snd_pkt</span><span class="p">(</span><span class="n">tAVDT_SCB</span> <span class="o">*</span><span class="n">p_scb</span><span class="p">,</span> <span class="n">tAVDT_SCB_EVT</span> <span class="o">*</span><span class="n">p_data</span><span class="p">)</span>
</span><span class='line'>  <span class="n">avdt_ad_write_req</span><span class="p">(</span><span class="n">AVDT_CHAN_MEDIA</span><span class="p">,</span> <span class="n">p_scb</span><span class="o">-&gt;</span><span class="n">p_ccb</span><span class="p">,</span> <span class="n">p_scb</span><span class="p">,</span> <span class="n">p_pkt</span><span class="p">);</span>
</span><span class='line'>      <span class="n">L2CA_DataWrite</span><span class="p">(</span><span class="n">avdt_cb</span><span class="p">.</span><span class="n">ad</span><span class="p">.</span><span class="n">rt_tbl</span><span class="p">[</span><span class="n">avdt_ccb_to_idx</span><span class="p">(</span><span class="n">p_ccb</span><span class="p">)][</span><span class="n">tcid</span><span class="p">].</span><span class="n">lcid</span><span class="p">,</span> <span class="n">p_buf</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>3 L2CAP to HCI layer</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">bluedroid</span><span class="o">/</span><span class="n">stack</span><span class="o">/</span><span class="n">l2cap</span><span class="o">/</span><span class="n">l2c_api</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'><span class="mi">1633</span> <span class="n">UINT8</span> <span class="n">L2CA_DataWrite</span> <span class="p">(</span><span class="n">UINT16</span> <span class="n">cid</span><span class="p">,</span> <span class="n">BT_HDR</span> <span class="o">*</span><span class="n">p_data</span><span class="p">)</span>
</span><span class='line'><span class="mi">1636</span>     <span class="k">return</span> <span class="n">l2c_data_write</span> <span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">p_data</span><span class="p">,</span> <span class="n">L2CAP_FLUSHABLE_CH_BASED</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">p_ccb</span> <span class="o">=</span> <span class="n">l2cu_find_ccb_by_cid</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">l2c_csm_execute</span> <span class="p">(</span><span class="n">p_ccb</span><span class="p">,</span> <span class="n">L2CEVT_L2CA_DATA_WRITE</span><span class="p">,</span> <span class="n">p_data</span><span class="p">);</span>
</span><span class='line'>                      <span class="mi">935</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">l2c_csm_open</span> <span class="p">(</span><span class="n">tL2C_CCB</span> <span class="o">*</span><span class="n">p_ccb</span><span class="p">,</span> <span class="n">UINT16</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p_data</span><span class="p">)</span><span class="c1">//Just consider channel connected state</span>
</span><span class='line'>                      <span class="mi">1050</span>     <span class="k">case</span> <span class="nl">L2CEVT_L2CA_DATA_WRITE:</span>                    <span class="cm">/* Upper layer data to send */</span>
</span><span class='line'>                      <span class="mi">1051</span>         <span class="n">l2c_enqueue_peer_data</span> <span class="p">(</span><span class="n">p_ccb</span><span class="p">,</span> <span class="p">(</span><span class="n">BT_HDR</span> <span class="o">*</span><span class="p">)</span><span class="n">p_data</span><span class="p">);</span>
</span><span class='line'>                      <span class="mi">1052</span>         <span class="n">l2c_link_check_send_pkts</span> <span class="p">(</span><span class="n">p_ccb</span><span class="o">-&gt;</span><span class="n">p_lcb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>                      <span class="mi">1053</span>         <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                              <span class="n">l2c_link_check_send_pkts</span> <span class="p">(</span><span class="n">p_lcb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>                                  <span class="n">l2c_link_send_to_lower</span> <span class="p">(</span><span class="n">p_lcb</span><span class="p">,</span> <span class="n">p_buf</span><span class="p">);</span>
</span><span class='line'>                                  <span class="mi">1341</span> <span class="err">#</span><span class="k">if</span> <span class="n">BLE_INCLUDED</span> <span class="o">==</span> <span class="n">TRUE</span>
</span><span class='line'>                                  <span class="mi">1342</span>         <span class="k">if</span> <span class="p">(</span><span class="n">p_lcb</span><span class="o">-&gt;</span><span class="n">is_ble_link</span><span class="p">)</span>
</span><span class='line'>                                  <span class="mi">1344</span>             <span class="n">L2C_LINK_SEND_BLE_ACL_DATA</span><span class="p">(</span><span class="n">p_buf</span><span class="p">);</span>
</span><span class='line'>                                  <span class="mi">1346</span>         <span class="k">else</span>
</span><span class='line'>                                  <span class="mi">1349</span>             <span class="n">L2C_LINK_SEND_ACL_DATA</span> <span class="p">(</span><span class="n">p_buf</span><span class="p">);</span>
</span><span class='line'>                                                      <span class="n">bte_main_hci_send</span><span class="p">((</span><span class="n">BT_HDR</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span><span class="p">),</span> <span class="n">BT_EVT_TO_LM_HCI_ACL</span><span class="p">);</span>
</span><span class='line'>                                                          <span class="n">bt_hc_if</span><span class="o">-&gt;</span><span class="n">transmit_buf</span><span class="p">((</span><span class="n">TRANSAC</span><span class="p">)</span><span class="n">p_msg</span><span class="p">,</span> <span class="err">\</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p_msg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span><span class="n">p_msg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
</span><span class='line'>                                                              <span class="n">bluedroid</span><span class="o">/</span><span class="n">hci</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bt_hci_bdroid</span><span class="p">.</span><span class="nl">c:</span><span class="mi">249</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">transmit_buf</span><span class="p">(</span><span class="n">TRANSAC</span> <span class="n">transac</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p_buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
</span><span class='line'>                                                                  <span class="n">utils_enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_q</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">transac</span><span class="p">);</span>
</span><span class='line'>                                                                  <span class="n">bthc_signal_event</span><span class="p">(</span><span class="n">HC_EVENT_TX</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>4 HCI content write to hardware device driver</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="mi">339</span> <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bt_hc_worker_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">HC_EVENT_TX</span><span class="p">)</span>
</span><span class='line'>          <span class="n">p_hci_if</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">sending_msg_que</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>          <span class="mi">593</span> <span class="kt">void</span> <span class="n">hci_h4_send_msg</span><span class="p">(</span><span class="n">HC_BT_HDR</span> <span class="o">*</span><span class="n">p_msg</span><span class="p">)</span>
</span><span class='line'>              <span class="n">bytes_sent</span> <span class="o">=</span> <span class="n">userial_write</span><span class="p">(</span><span class="n">event</span><span class="p">,(</span><span class="n">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">,</span><span class="n">bytes_to_send</span><span class="p">);</span>
</span><span class='line'>                   <span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">userial_cb</span><span class="p">.</span><span class="n">fd</span><span class="p">,</span> <span class="n">p_data</span><span class="o">+</span><span class="n">total</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Item C. Incoming data/event path:</h3>

<p>0 Init vendor (BT chip vendor, like MRVL/TI) implement of bt_vendor_interface_t interface.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'>  <span class="mi">187</span> <span class="kt">void</span> <span class="n">init_vnd_if</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">local_bdaddr</span><span class="p">)</span>
</span><span class='line'>          <span class="n">dlhandle</span> <span class="o">=</span> <span class="n">dlopen</span><span class="p">(</span><span class="s">&quot;libbt-vendor.so&quot;</span><span class="p">,</span> <span class="n">RTLD_NOW</span><span class="p">);</span>               
</span><span class='line'>          <span class="n">GLOBAL</span> <span class="n">bt_vendor_interface_t</span> <span class="o">*</span><span class="n">bt_vnd_if</span> <span class="o">=</span> <span class="p">(</span><span class="n">bt_vendor_interface_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">dlhandle</span><span class="p">,</span> <span class="s">&quot;BLUETOOTH_VENDOR_LIB_INTERFACE&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">bt_vnd_if</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnd_callbacks</span><span class="p">,</span> <span class="n">local_bdaddr</span><span class="p">);</span>
</span><span class='line'>          
</span><span class='line'>  <span class="mi">306</span> <span class="n">uint8_t</span> <span class="n">userial_open</span><span class="p">(</span><span class="n">uint8_t</span> <span class="n">port</span><span class="p">)</span>
</span><span class='line'>          <span class="n">result</span> <span class="o">=</span> <span class="n">bt_vendor_interface_t</span> <span class="o">*</span> <span class="n">bt_vnd_if</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">(</span><span class="n">BT_VND_OP_USERIAL_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fd_array</span><span class="p">);</span>
</span><span class='line'>              <span class="kt">int</span> <span class="n">bt_vnd_mrvl_if_op</span><span class="p">(</span><span class="n">bt_vendor_opcode_t</span> <span class="n">opcode</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
</span><span class='line'>                  <span class="n">mchar_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/mbtchar0&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span><span class='line'>  <span class="mi">363</span>     <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">userial_cb</span><span class="p">.</span><span class="n">read_thread</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">thread_attr</span><span class="p">,</span> <span class="n">userial_read_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>1 Got a packet from hardware device driver, in HCI layer.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">bluedroid</span><span class="o">/</span><span class="n">hci</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">userial</span><span class="p">.</span><span class="nl">c:</span><span class="mi">210</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">userial_read_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>  <span class="n">rx_length</span> <span class="o">=</span> <span class="n">select_read</span><span class="p">(</span><span class="n">userial_cb</span><span class="p">.</span><span class="n">fd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">READ_LIMIT</span><span class="p">);</span>
</span><span class='line'>      <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">,</span> <span class="p">(</span><span class="n">size_t</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
</span><span class='line'>  <span class="n">utils_enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">userial_cb</span><span class="p">.</span><span class="n">rx_q</span><span class="p">),</span> <span class="n">p_buf</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">//bluedroid/hci/src/bt_hci_bdroid.c</span>
</span><span class='line'>  <span class="n">bthc_signal_event</span><span class="p">(</span><span class="n">HC_EVENT_RX</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>2 Transfer this to L2CAP layer.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">bluedroid</span><span class="o">/</span><span class="n">hci</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bt_hci_bdroid</span><span class="p">.</span><span class="n">c</span>  
</span><span class='line'><span class="mi">339</span> <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bt_hc_worker_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">HC_EVENT_RX</span><span class="p">)</span>
</span><span class='line'>       <span class="n">p_hci_if</span><span class="o">-&gt;</span><span class="n">rcv</span><span class="p">();</span>
</span><span class='line'>          <span class="n">uint16_t</span> <span class="n">hci_h4_receive_msg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="c1">//Construct HCI EVENT/ACL packets and send them to stack</span>
</span><span class='line'> <span class="mi">957</span>             <span class="k">if</span> <span class="p">(</span><span class="n">p_cb</span><span class="o">-&gt;</span><span class="n">p_rcv_msg</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">!=</span> <span class="n">MSG_HC_TO_STACK_HCI_ACL</span><span class="p">)</span>
</span><span class='line'> <span class="mi">958</span>                 <span class="n">btsnoop_capture</span><span class="p">(</span><span class="n">p_cb</span><span class="o">-&gt;</span><span class="n">p_rcv_msg</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span><span class="c1">//dump to HCI trace file/socket.</span>
</span><span class='line'> <span class="mi">960</span>             <span class="k">if</span> <span class="p">(</span><span class="n">p_cb</span><span class="o">-&gt;</span><span class="n">p_rcv_msg</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">==</span> <span class="n">MSG_HC_TO_STACK_HCI_EVT</span><span class="p">)</span>
</span><span class='line'> <span class="mi">965</span>                 <span class="n">bt_hc_cbacks</span><span class="o">-&gt;</span><span class="n">data_ind</span><span class="p">((</span><span class="n">TRANSAC</span><span class="p">)</span> <span class="n">p_cb</span><span class="o">-&gt;</span><span class="n">p_rcv_msg</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">p_cb</span><span class="o">-&gt;</span><span class="n">p_rcv_msg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">p_cb</span><span class="o">-&gt;</span><span class="n">p_rcv_msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">BT_HC_HDR_SIZE</span><span class="p">);</span>
</span><span class='line'>                          <span class="n">bluedroid</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">bte_main</span><span class="p">.</span><span class="nl">c:</span><span class="mi">504</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">data_ind</span><span class="p">(</span><span class="n">TRANSAC</span> <span class="n">transac</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p_buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
</span><span class='line'>                              <span class="n">GKI_send_msg</span> <span class="p">(</span><span class="n">BTU_TASK</span><span class="p">,</span> <span class="n">BTU_HCI_RCV_MBOX</span><span class="p">,</span> <span class="n">transac</span><span class="p">);</span><span class="c1">//handle in btu_task.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reference:</p>

<blockquote><p></p><footer><strong>logcat:A2DP</strong> <cite><a href='http://yongbingchen.github.com/txt/bluedroid/a2dp-init-logcat.txt'>yongbingchen.github.com/txt/&hellip;</a></cite></footer></blockquote>


<blockquote><p></p><footer><strong>air log: LMP</strong> <cite><a href='http://yongbingchen.github.com/images/bluedroid/A2DP-connect-LMP.jpg'>yongbingchen.github.com/images/&hellip;</a></cite></footer></blockquote>


<blockquote><p></p><footer><strong>air log: L2CAP</strong> <cite><a href='http://yongbingchen.github.com/images/bluedroid/A2DP-connect-L2CAP.jpg'>yongbingchen.github.com/images/&hellip;</a></cite></footer></blockquote>


<blockquote><p></p><footer><strong>source code reading note</strong> <cite><a href='http://yongbingchen.github.com/txt/bluedroid/a2dp-source-code-reading-note.txt'>yongbingchen.github.com/txt/&hellip;</a></cite></footer></blockquote>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/05/07/dissect-bluedroid-from-a2dp-part-iii-init-a2dp-service/">Dissect Bluedroid From A2DP: Part III: Init A2DP Service</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-05-07T04:17:00-07:00" pubdate data-updated="true">May 7<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/05/07/dissect-bluedroid-from-a2dp-part-iii-init-a2dp-service/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="center" src="http://yongbingchen.github.com/images/bluedroid/init_a2dp_service.jpg" title="" >
1 Get Android defined A2DP interface btav_interface_t from bt_interface_t get_bluetooth_interface().</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="mo">04</span><span class="o">-</span><span class="mi">25</span> <span class="mo">01</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mf">30.530</span> <span class="n">I</span><span class="o">/</span><span class="n">BluetoothA2dpServiceJni</span><span class="p">(</span> <span class="mi">2093</span><span class="p">)</span><span class="o">:</span> <span class="nl">classInitNative:</span> <span class="n">succeeds</span>
</span><span class='line'><span class="n">packages</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">Bluetooth</span><span class="o">/</span><span class="n">jni</span><span class="o">/</span><span class="n">com_android_bluetooth_a2dp</span><span class="p">.</span><span class="n">cpp</span>
</span><span class='line'><span class="mi">137</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">initNative</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">object</span><span class="p">)</span>
</span><span class='line'>  <span class="n">GLOBAL</span> <span class="k">const</span> <span class="n">btav_interface_t</span> <span class="o">*</span><span class="n">sBluetoothA2dpInterface</span> <span class="o">=</span> <span class="p">(</span><span class="n">btav_interface_t</span> <span class="o">*</span><span class="p">)</span><span class="n">btInf</span><span class="o">-&gt;</span><span class="n">get_profile_interface</span><span class="p">(</span><span class="n">BT_PROFILE_ADVANCED_AUDIO_ID</span><span class="p">);</span>
</span><span class='line'>  <span class="n">sBluetoothA2dpInterface</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sBluetoothA2dpCallbacks</span><span class="p">);</span>
</span><span class='line'>      <span class="n">external</span><span class="o">/</span><span class="n">bluetooth</span><span class="o">/</span><span class="n">bluedroid</span><span class="o">/</span><span class="n">btif</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">btif_av</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'>      <span class="mi">725</span> <span class="k">static</span> <span class="n">bt_status_t</span> <span class="n">init</span><span class="p">(</span><span class="n">btav_callbacks_t</span><span class="o">*</span> <span class="n">callbacks</span> <span class="p">)</span>
</span><span class='line'>          <span class="mi">686</span> <span class="kt">int</span> <span class="n">btif_a2dp_start_media_task</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>              <span class="n">GKI_create_task</span><span class="p">((</span><span class="n">TASKPTR</span><span class="p">)</span><span class="n">btif_media_task</span><span class="p">,</span> <span class="n">A2DP_MEDIA_TASK</span><span class="p">,</span>
</span><span class='line'>          <span class="n">btif_enable_service</span><span class="p">(</span><span class="n">BTA_A2DP_SERVICE_ID</span><span class="p">);</span><span class="c1">//Upon BT enable, BTIF core shall invoke the BTA APIs to enable the profiles</span>
</span></code></pre></td></tr></table></div></figure>


<p>2 Init A2DP service by btav_interface_t->init().</p>

<pre><code>* Start a btif_media_task as main loop for A2DP service.
* Open a socket to listen on client's connect request from control channel.
</code></pre>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">external</span><span class="o">/</span><span class="n">bluetooth</span><span class="o">/</span><span class="n">bluedroid</span><span class="o">/</span><span class="n">btif</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">btif_media_task</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'><span class="c1">//Task for SBC encoder.  This task receives an event when the waveIn interface has a pcm data buffer ready.  On receiving the event, handle all ready pcm data buffers.  If stream is started, run the SBC encoder on each chunk of pcm samples and build an output packet consisting of one or more encoded SBC frames.</span>
</span><span class='line'><span class="mi">1066</span> <span class="kt">int</span> <span class="n">btif_media_task</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
</span><span class='line'><span class="mi">1073</span>     <span class="n">btif_media_task_init</span><span class="p">();</span>
</span><span class='line'><span class="mi">1044</span>     <span class="n">UIPC_Init</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>          <span class="mi">606</span> <span class="n">UDRV_API</span> <span class="kt">void</span> <span class="n">UIPC_Init</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p_data</span><span class="p">)</span>
</span><span class='line'>              <span class="mi">569</span> <span class="kt">int</span> <span class="n">uipc_start_main_server_thread</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>                  <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uipc_main</span><span class="p">.</span><span class="n">tid</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="n">pthread_attr_t</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">uipc_read_task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'><span class="mi">1047</span>     <span class="n">UIPC_Open</span><span class="p">(</span><span class="n">UIPC_CH_ID_AV_CTRL</span> <span class="p">,</span> <span class="n">btif_a2dp_ctrl_cb</span><span class="p">);</span>
</span><span class='line'>          <span class="n">uipc_setup_server_locked</span><span class="p">(</span><span class="n">ch_id</span><span class="p">,</span> <span class="n">A2DP_CTRL_PATH</span><span class="p">,</span> <span class="n">p_cback</span><span class="p">);</span><span class="c1">//This is the control socket that listen on A2DP client.</span>
</span><span class='line'><span class="mi">1079</span>     <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="c1">//A2DP event loop </span>
</span><span class='line'><span class="mi">1080</span>     <span class="p">{</span>
</span><span class='line'><span class="mi">1085</span>         <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">BTIF_MEDIA_TASK_CMD</span><span class="p">)</span>
</span><span class='line'><span class="mi">1090</span>                 <span class="n">btif_media_task_handle_cmd</span><span class="p">(</span><span class="n">p_msg</span><span class="p">);</span>
</span><span class='line'><span class="mi">1093</span>
</span><span class='line'><span class="mi">1094</span>         <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">BTIF_MEDIA_TASK_DATA</span><span class="p">)</span>
</span><span class='line'><span class="mi">1099</span>                 <span class="n">btif_media_task_handle_media</span><span class="p">(</span><span class="n">p_msg</span><span class="p">);</span>
</span><span class='line'><span class="mi">1102</span>
</span><span class='line'><span class="mi">1103</span>         <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">BTIF_MEDIA_AA_TASK_TIMER</span><span class="p">)</span>
</span><span class='line'><span class="mi">1105</span>             <span class="cm">/* advance audio timer expiration */</span>
</span><span class='line'><span class="mi">1106</span>             <span class="n">btif_media_task_aa_handle_timer</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reference:</p>

<blockquote><p></p><footer><strong>logcat:A2DP</strong> <cite><a href='http://yongbingchen.github.com/txt/bluedroid/a2dp-init-logcat.txt'>yongbingchen.github.com/txt/&hellip;</a></cite></footer></blockquote>


<blockquote><p></p><footer><strong>air log: LMP</strong> <cite><a href='http://yongbingchen.github.com/images/bluedroid/A2DP-connect-LMP.jpg'>yongbingchen.github.com/images/&hellip;</a></cite></footer></blockquote>


<blockquote><p></p><footer><strong>air log: L2CAP</strong> <cite><a href='http://yongbingchen.github.com/images/bluedroid/A2DP-connect-L2CAP.jpg'>yongbingchen.github.com/images/&hellip;</a></cite></footer></blockquote>


<blockquote><p></p><footer><strong>source code reading note</strong> <cite><a href='http://yongbingchen.github.com/txt/bluedroid/a2dp-source-code-reading-note.txt'>yongbingchen.github.com/txt/&hellip;</a></cite></footer></blockquote>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/05/04/dissect-bluedroid-from-a2dp-part-ii-init-bluetooth-adapter/">Dissect Bluedroid From A2DP: Part II: Init Bluetooth Adapter</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-05-04T02:37:00-07:00" pubdate data-updated="true">May 4<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/05/04/dissect-bluedroid-from-a2dp-part-ii-init-bluetooth-adapter/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Android defined one interface bt_interface_t to control a Bluetooth Adapter, Bluedroid implemented this interface as &#8220;static const bt_interface_t bluetoothInterface&#8221; in external/bluetooth/bluedroid/btif/src/bluetooth.c.</p>

<p><img class="center" src="http://yongbingchen.github.com/images/bluedroid/init_bt_adapter.jpg" title="" ></p>

<blockquote><p></p><footer><strong>logcat:A2DP</strong> <cite><a href='http://yongbingchen.github.com/txt/bluedroid/a2dp-init-logcat.txt'>yongbingchen.github.com/txt/&hellip;</a></cite></footer></blockquote>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/05/03/dissect-bluedroid-from-a2dp-part-i-use-case/">Dissect Bluedroid From A2DP Part I: Use Case</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-05-03T22:05:00-07:00" pubdate data-updated="true">May 3<span>rd</span>, 2013</time>
        
         | <a href="/blog/2013/05/03/dissect-bluedroid-from-a2dp-part-i-use-case/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Android framework defined two hardware interfaces for operating audio output devices, they are audio_hw_device_t and audio_stream_out_t, AudioFlinger is the only user of these interfaces. Bluedroid implemented these two interface in external/bluetooth/bluedroid/audio_a2dp_hw/audio_a2dp_hw.c, AudioFlinger can output audio sample to a connected A2DP sink device if this implementation has been registered to Android.</p>

<p><img src="http://yongbingchen.github.com/images/bluedroid/A2dp_use_case.jpg" title="" ></p>

<p>In Bluedroid&#8217;s A2DP hardware implementation, it will use two sockets to communicate with A2DP server.</p>

<p><img class="center" src="http://yongbingchen.github.com/images/bluedroid/audio_a2dp_hw_bluedroid.jpg" title="" ></p>

<p>Reference:</p>

<blockquote><p></p><footer><strong>Source Code</strong> <cite><a href='http://androidxref.com/4.2.2_r1'>androidxref.com/4.2.2_r1/&hellip;</a></cite></footer></blockquote>


<blockquote><p></p><footer><strong>logcat:A2DP</strong> <cite><a href='http://yongbingchen.github.com/txt/bluedroid/a2dp-init-logcat.txt'>yongbingchen.github.com/txt/&hellip;</a></cite></footer></blockquote>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/04/23/skeleton-of-a-bluetooth-sdio-driver/">Skeleton of a Bluetooth SDIO Driver</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-04-23T05:28:00-07:00" pubdate data-updated="true">Apr 23<span>rd</span>, 2013</time>
        
         | <a href="/blog/2013/04/23/skeleton-of-a-bluetooth-sdio-driver/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A Bluetooth SDIO card driver talks with hardware through SDIO interface, providing R/W method for Bluetooth Adapter layer, here&#8217;s the class diagram for this relationship:</p>

<p><img src="http://yongbingchen.github.com/images/bt_drv/bt_drv_class_diagram.jpg" title="" ></p>

<p>The outbound Bluetooth data path:</p>

<ol>
<li>Upper layer use HCI interface send() to send data/command packet, implemented as btmrvl_send_frame() in this driver.</li>
<li>Put this packet in adapter&#8217;s tx queue, wakeup the main data processing thread (like NAPI in a network driver, thread function is btmrvl_service_main_thread()).</li>
<li>In main data procssing thread, re-organize skb data payload for DMA transfer (in btmrvl_tx_pkt()).</li>
<li>Call sdio_writesb() to write data to hardware (in btmrvl_sdio_host_to_card()).</li>
</ol>


<p>The incoming Bluetooth data path:</p>

<ol>
<li>SDIO card received a data packet, triggered a interrupt to host.</li>
<li>The SDIO ISR triggred the main data processing thread.</li>
<li>In this thread, allocate a skb with DAM aligned, call sdio_readsb() to read the data from SDIO interface (in btmrvl_sdio_card_to_host()).</li>
<li>Call hci_recv_frame(skb) to send this data packet to upper layer Bluetooth stack.</li>
</ol>


<p>Appendix: How to register a driver specific ISR to SDIO&#8217;s ISR:</p>

<figure class='code'><figcaption><span>In driver module init, hook up a device ISR to SDIO&#8217;s ISR.  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="kt">int</span> <span class="n">__init</span> <span class="nf">btmrvl_sdio_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>    <span class="o">|</span>
</span><span class='line'>    <span class="o">|</span>
</span><span class='line'>    <span class="o">--&gt;</span><span class="n">sdio_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_mrvl_sdio</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="o">|</span>
</span><span class='line'>      <span class="o">|</span>
</span><span class='line'>      <span class="o">--&gt;</span><span class="n">btmrvl_sdio_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdio_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>          <span class="o">|</span>
</span><span class='line'>          <span class="o">|</span>
</span><span class='line'>          <span class="o">--&gt;</span><span class="n">sdio_claim_irq</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">btmrvl_sdio_interrupt</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>In this ISR, wake up main data pocessing thread to read data from card.  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="kt">void</span> <span class="nf">btmrvl_sdio_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
</span><span class='line'>    <span class="o">|</span>
</span><span class='line'>    <span class="o">|</span>
</span><span class='line'>    <span class="o">--&gt;</span><span class="n">btmrvl_interrupt</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
</span><span class='line'>      <span class="o">|</span>
</span><span class='line'>      <span class="o">|</span>
</span><span class='line'>      <span class="o">--&gt;</span><span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">main_thread</span><span class="p">.</span><span class="n">wait_q</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Source Code:</p>

<blockquote><p></p><footer><strong>@btmrvl_sdio.c</strong> <cite><a href='http://lxr.linux.no/linux+v3.8.8/drivers/bluetooth/btmrvl_sdio.c'>lxr.linux.no/linux+v3.8.8/&hellip;</a></cite></footer></blockquote>


<blockquote><p></p><footer><strong>@btmrvl_main.c</strong> <cite><a href='http://lxr.linux.no/linux+v3.8.8/drivers/bluetooth/btmrvl_main.c'>lxr.linux.no/linux+v3.8.8/&hellip;</a></cite></footer></blockquote>


<h2>Note: How to load firmware for a SDIO device</h2>

<figure class='code'><figcaption><span>1. Disable interrupt from this SDIO device.  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">sdio_claim_host</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
</span><span class='line'><span class="n">btmrvl_sdio_disable_host_int</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
</span><span class='line'>  <span class="n">host_int_mask</span> <span class="o">=</span> <span class="n">sdio_readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
</span><span class='line'>  <span class="n">host_int_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HIM_DISABLE</span><span class="p">;</span>
</span><span class='line'>  <span class="n">sdio_writeb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">host_int_mask</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">host_int_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
</span><span class='line'><span class="n">sdio_release_host</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>2. Get and Write firmware.  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">sdio_claim_host</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">//Get firmware from user space.</span>
</span><span class='line'>  <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_firmware</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">,</span><span class="c1">//name of firmware file, = &quot;mrvl/sd8787_uapsta.bin&quot;,</span>
</span><span class='line'>          <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">//Write firmware into SDIO device, check firmware status.</span>
</span><span class='line'>  <span class="n">tmpfwbufsz</span> <span class="o">=</span> <span class="n">ALIGN_SZ</span><span class="p">(</span><span class="n">BTM_UPLD_SIZE</span><span class="p">,</span> <span class="n">BTSDIO_DMA_ALIGN</span><span class="p">);</span>
</span><span class='line'>  <span class="n">fwbuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ALIGN_ADDR</span><span class="p">(</span><span class="n">tmpfwbuf</span><span class="p">,</span> <span class="n">BTSDIO_DMA_ALIGN</span><span class="p">);</span>
</span><span class='line'>  <span class="n">memcpy</span><span class="p">(</span><span class="n">fwbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">firmware</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">txlen</span><span class="p">);</span>
</span><span class='line'>  <span class="n">sdio_writesb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">,</span> <span class="n">fwbuf</span><span class="p">,</span><span class="n">tx_blocks</span> <span class="o">*</span> <span class="n">blksz_dl</span><span class="p">);</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">//Release firmware related resource in kernel.</span>
</span><span class='line'>  <span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_firmware</span><span class="p">);</span>
</span><span class='line'><span class="n">sdio_release_host</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alternatively, you can use request_firmware_nowait() if current thread is not allowed to sleep for a long time.</p>

<figure class='code'><figcaption><span>3. Enable SDIO device interrupt.  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">btmrvl_sdio_enable_host_int</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reference:</p>

<blockquote><p></p><footer><strong>@How request_firmware() works</strong> <cite><a href='http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/Documentation/firmware_class/README?id=HEAD'>git.kernel.org/cgit/linux/git/&hellip;</a></cite></footer></blockquote>


<blockquote><p></p><footer><strong>@Default firmware search path in Android</strong> <cite><a href='http://stackoverflow.com/questions/6019915/kernel-module-cannot-find-firmware-file-where-should-it-be'>stackoverflow.com/questions/&hellip;</a></cite></footer></blockquote>




<figure class='code'><figcaption><span>$Jellybean/system/core/init/devices.c  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define SYSFS_PREFIX    &quot;/sys&quot;</span>
</span><span class='line'><span class="cp">#define FIRMWARE_DIR1   &quot;/etc/firmware&quot;</span>
</span><span class='line'><span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="p">,</span> <span class="n">SYSFS_PREFIX</span><span class="s">&quot;%s/&quot;</span><span class="p">,</span> <span class="n">uevent</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
</span><span class='line'><span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file1</span><span class="p">,</span> <span class="n">FIRMWARE_DIR1</span><span class="s">&quot;/%s&quot;</span><span class="p">,</span> <span class="n">uevent</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">);</span>
</span><span class='line'><span class="n">fw_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Footnote: sdio_claim_host(card->func)</h1>

<ol>
<li>card->func means an independent function residues in same card (there maybe different functions implemented in same card simultaneously, like BT and Wifi in MRVL 8787 module. The device field in struct sdio_device_id is used as function id to distinguish these functions, in this driver, the device field in driver is 0x911B for MRVL_BT_SD8787, it reflected as:
0x911b in /sys/class/mmc_host/mmc1/mmc1\:0001/mmc1\:0001\:3/device.</li>
<li>sdio_claim_host() is acting like a lock, I guess this will serialize access to same SD device between different functions, and also between different threads inside same function.</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/03/23/memo-how-a-process-accesses-physical-memory/">Refresh Memo: How a Process Accesses Physical Memory</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-03-23T21:39:00-07:00" pubdate data-updated="true">Mar 23<span>rd</span>, 2013</time>
        
         | <a href="/blog/2013/03/23/memo-how-a-process-accesses-physical-memory/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Scenario: a process acquired a new block of memory, then try to access part of this block:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>                <span class="o">*</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>What happens in malloc():</p>

<ol>
<li>stdlib will try to handle it internally, if can&#8217;t satisfy this request, then,</li>
<li>Call sbrk() to let kernel enlarge current process&#8217;s heap space (by adjust process&#8217;s VMAs).</li>
</ol>


<p>What happens next when try to access the memory:</p>

<ol>
<li>CPU&#8217;s MMU use this virtual address to look up in current CPU&#8217;s TLB, not found.</li>
<li>Then MMU switch to look up this address in process&#8217;s Page Table, try to do the virtual-to-physical address translation.</li>
<li>Step 2 will fail, a Page Fault exception happens.

<ul>
<li>In Page Fault exception handler, check if current process has write permission to this address, that&#8217;s done by check process&#8217;s VMA list.</li>
<li>Allocate a physical page, update process&#8217;s Page Table for this page.</li>
</ul>
</li>
<li>After the exception handler returned, and the process get scheduled to execute again, it will retry the instruction that caused the Page Fault, this time will get correct physical address pointed to the new page. Update TLB entry for this new map.</li>
<li>Select proper line in Cache for this physical address, write the new value to Cache, then hardware will write back this new value from Cache to real memory at proper time.</li>
</ol>


<blockquote><p></p><footer><strong>@How Xscale Handle Cache Miss</strong> <cite><a href='http://www.cs.uiuc.edu/homes/luddy/PROCESSORS/XScaleMMX.pdf'>www.cs.uiuc.edu/homes/luddy/&hellip;</a></cite></footer></blockquote>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/03/11/read-e-edid-with-clock-stretching/">Read e-EDID With Clock Stretching</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-03-11T17:00:00-07:00" pubdate data-updated="true">Mar 11<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/03/11/read-e-edid-with-clock-stretching/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Read e-EDID with master clock stretching</h2>

<p>In E-DDC, a special I²C addressing scheme was introduced, in which multiple 256-byte segments could be selected. To do this, a single 8-bit segment index is passed to the display via the I²C address 30h. (Because this access is always a write, the first I²C octet will always be 60h.).</p>

<p>In my MHL project, this first write will always get an I2C NO_ACK error(E-DDC need tolerate with NO_ACK error for this write, to be back-compatible with legacy DDC, so we are using GPIO to simulate I2C, instead of using standard I2C controller).</p>

<p>From below signal, we found the ACK actually came, but master did not acquire it at that time, that&#8217;s exactly what clock stretching targeted at.</p>

<p><img src="http://yongbingchen.github.com/images/edid/write_0x60_clock_stretch.jpg" title="" ></p>

<p>Add clock stretching logic in our GPIO simulation function, then can successfully read all e-EDID segments.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/03/11/sending-a-signal-from-linux-kernel/">Sending a Signal From Linux Kernel</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-03-11T06:17:00-07:00" pubdate data-updated="true">Mar 11<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/03/11/sending-a-signal-from-linux-kernel/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Send SIGUSR1 from kernel</strong></p>

<p>I want to use a signal to inform an asynchronous event from one kernel module to a user space application.</p>

<p>To achieve this, add below code in kernel driver:</p>

<figure class='code'><figcaption><span>patch on kernel module  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">linux</span><span class="o">/</span><span class="n">sched</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">asm</span><span class="o">/</span><span class="n">siginfo</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">linux</span><span class="o">/</span><span class="n">pid_namespace</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">linux</span><span class="o">/</span><span class="n">pid</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="k">enum</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'><span class="o">+</span>       <span class="n">THIS_MODULE_IOCTL_SET_OWNER</span> <span class="o">=</span> <span class="mh">0x111</span><span class="p">,</span>
</span><span class='line'> <span class="p">}</span><span class="n">MODULE_IOCTL_CMD</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="o">+</span><span class="k">static</span> <span class="kt">int</span> <span class="n">owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span><span class="k">static</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span> <span class="n">current_task</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="o">+</span><span class="k">static</span> <span class="kt">void</span> <span class="n">send_signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig_num</span><span class="p">)</span>
</span><span class='line'><span class="o">+</span><span class="p">{</span>
</span><span class='line'><span class="o">+</span>       <span class="k">if</span> <span class="p">(</span><span class="n">owner</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="o">+</span>               <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s,%d.sending to owner %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>       <span class="k">struct</span> <span class="n">siginfo</span> <span class="n">info</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">siginfo</span><span class="p">));</span>
</span><span class='line'><span class="o">+</span>       <span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">sig_num</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="n">info</span><span class="p">.</span><span class="n">si_int</span> <span class="o">=</span> <span class="mi">1234</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="k">if</span> <span class="p">(</span><span class="n">current_task</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span><span class='line'><span class="o">+</span>               <span class="n">rcu_read_lock</span><span class="p">();</span>
</span><span class='line'><span class="o">+</span>               <span class="n">current_task</span> <span class="o">=</span> <span class="n">pid_task</span><span class="p">(</span><span class="n">find_vpid</span><span class="p">(</span><span class="n">owner</span><span class="p">),</span> <span class="n">PIDTYPE_PID</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>               <span class="n">rcu_read_unlock</span><span class="p">();</span>
</span><span class='line'><span class="o">+</span>       <span class="p">}</span>
</span><span class='line'><span class="o">+</span>       <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">send_sig_info</span><span class="p">(</span><span class="n">sig_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current_task</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>       <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="o">+</span>               <span class="n">printk</span><span class="p">(</span><span class="s">&quot;error sending signal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>       <span class="p">}</span>
</span><span class='line'><span class="o">+</span><span class="p">}</span>
</span><span class='line'><span class="o">+</span>
</span><span class='line'> <span class="k">static</span> <span class="kt">int</span> <span class="n">device_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">INTRESTED_EVENT</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="o">+</span>                       <span class="n">send_signal</span><span class="p">(</span><span class="n">SIGUSR1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="err">@@</span> <span class="o">-</span><span class="mi">325</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">352</span><span class="p">,</span><span class="mi">13</span> <span class="err">@@</span> <span class="k">static</span> <span class="kt">long</span> <span class="n">device_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
</span><span class='line'><span class="o">+</span>       <span class="k">case</span> <span class="n">THIS_MODULE_IOCTL_SET_OWNER</span>:
</span><span class='line'><span class="o">+</span>               <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s, owner pid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>               <span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">owner</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))){</span>
</span><span class='line'><span class="o">+</span>                       <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>               <span class="p">}</span>
</span><span class='line'><span class="o">+</span>               <span class="n">current_task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>               <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="o">+</span><span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>In user space application, set its pid to kernel module, then listen on the signal.</p>

<figure class='code'><figcaption><span>patch on user application  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">pthread</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">semaphore</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">signal</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">+</span><span class="k">static</span> <span class="n">sem_t</span> <span class="n">event_sem</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span><span class="k">static</span> <span class="k">volatile</span> <span class="kt">sig_atomic_t</span> <span class="n">intrested_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>
</span><span class='line'><span class="o">+</span><span class="kt">void</span> <span class="n">sig_handler_event1</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
</span><span class='line'><span class="o">+</span><span class="p">{</span>
</span><span class='line'><span class="o">+</span>       <span class="n">interested_event</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event_sem</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">+</span><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">event_handler_thread_func</span><span class="p">()</span>
</span><span class='line'><span class="o">+</span><span class="p">{</span>
</span><span class='line'><span class="o">+</span>        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
</span><span class='line'><span class="o">+</span>                <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event_sem</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>                <span class="k">if</span> <span class="p">(</span><span class="n">intrested_event</span><span class="p">){</span>
</span><span class='line'><span class="o">+</span>                        <span class="n">LOGD</span><span class="p">(</span><span class="s">&quot;%s,%d, received intrested_event signal.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>                        <span class="n">intrested_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>                <span class="p">}</span>
</span><span class='line'><span class="o">+</span>        <span class="p">}</span>
</span><span class='line'><span class="o">+</span>        <span class="n">pthread_exit</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="o">+</span>               <span class="n">pthread_t</span> <span class="n">event_thread</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>               <span class="k">if</span> <span class="p">(</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">event_handler_thread_func</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Thread create failed%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span><span class='line'><span class="o">+</span>                  <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>               <span class="p">}</span>
</span><span class='line'><span class="o">+</span>               <span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event_sem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">+</span>               <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">usr_action</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>               <span class="n">sigset_t</span> <span class="n">block_mask</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>               <span class="n">sigfillset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">block_mask</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>               <span class="n">usr_action</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">sig_handler_event1</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>               <span class="n">usr_action</span><span class="p">.</span><span class="n">sa_mask</span> <span class="o">=</span> <span class="n">block_mask</span><span class="p">;</span><span class="c1">//block all signal inside signal handler.</span>
</span><span class='line'><span class="o">+</span>               <span class="n">usr_action</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="n">SA_NODEFER</span><span class="p">;</span><span class="c1">//do not block SIGUSR1 within sig_handler_int.</span>
</span><span class='line'><span class="o">+</span>               <span class="n">sigaction</span> <span class="p">(</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usr_action</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>               <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/target_device_name&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>               <span class="kt">int</span> <span class="n">my_pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>
</span><span class='line'><span class="o">+</span>               <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mh">0x111</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">my_pid</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>               <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>A signal could interrupt below primitive calls:
<em>close, fcntl (operation F_SETLK), open, read, recv, recvfrom, select, send, sendto, tcdrain, waitpid, wait, and write</em>,
POXIS and BSD will handle this situation differently. POXIS will fail these primitive call with EINTR, caller need to use macro TEMP_FAILURE_RETRY (expression) to retry.
Programmer need to take care of this issue.</p>

<p>Reference:</p>

<blockquote><p></p><footer><strong>@glibc-manual-0.02</strong> <cite><a href='http://www.cs.utah.edu/dept/old/texinfo/glibc-manual-0.02/library_21.html#sec349'>www.cs.utah.edu/dept/old/&hellip;</a></cite></footer></blockquote>


<blockquote><p></p><footer><strong>@ldd3</strong> <cite><a href='http://www.makelinux.net/ldd3/chp-6-sect-2'>www.makelinux.net/ldd3/&hellip;</a></cite></footer></blockquote>


<h1>Sending Signal Across Processes</h1>

<p>In receiver process, create a share memory, write receiver&#8217;s pid to it, then wait for the signal.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span>  <span class="o">&lt;</span><span class="n">signal</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span>  <span class="o">&lt;</span><span class="n">sys</span><span class="o">/</span><span class="n">ipc</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span>  <span class="o">&lt;</span><span class="n">sys</span><span class="o">/</span><span class="n">shm</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">pthread</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">semaphore</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">define</span> <span class="n">MY_IPC_KEY_PATH</span> <span class="s">&quot;/data/misc/bluedroid&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="o">+</span><span class="k">static</span> <span class="n">sem_t</span> <span class="n">event_sem</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span><span class="k">static</span> <span class="k">volatile</span> <span class="kt">sig_atomic_t</span> <span class="n">intrested_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>
</span><span class='line'><span class="o">+</span><span class="k">static</span> <span class="kt">void</span> <span class="n">sig_handler_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
</span><span class='line'><span class="o">+</span><span class="p">{</span>
</span><span class='line'><span class="o">+</span>       <span class="n">interested_event</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event_sem</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span><span class="p">}</span>
</span><span class='line'><span class="o">+</span>
</span><span class='line'><span class="o">+</span><span class="k">static</span> <span class="kt">void</span> <span class="n">wait_for_signal</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="o">+</span><span class="p">{</span>
</span><span class='line'><span class="o">+</span>       <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>
</span><span class='line'><span class="o">+</span>       <span class="n">key_t</span> <span class="n">my_ipc_key</span>   <span class="o">=</span> <span class="n">ftok</span><span class="p">(</span><span class="n">MY_IPC_KEY_PATH</span><span class="p">,</span> <span class="sc">&#39;s&#39;</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>       <span class="kt">int</span> <span class="n">share_mem_id</span>   <span class="o">=</span> <span class="n">shmget</span><span class="p">(</span><span class="n">my_ipc_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pid_t</span><span class="p">),</span> <span class="n">IPC_CREAT</span> <span class="o">|</span> <span class="mo">0666</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>       <span class="n">pid_t</span> <span class="o">*</span><span class="n">share_mem</span>  <span class="o">=</span> <span class="p">(</span><span class="n">pid_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">shmat</span><span class="p">(</span><span class="n">share_mem_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>       <span class="o">*</span><span class="n">share_mem</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>
</span><span class='line'><span class="o">+</span>       <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s,%d, set my pid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>
</span><span class='line'><span class="o">+</span>       <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">usr_action</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="n">sigset_t</span> <span class="n">block_mask</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="n">sigfillset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">block_mask</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>       <span class="n">usr_action</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">sig_handler_int</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="n">usr_action</span><span class="p">.</span><span class="n">sa_mask</span> <span class="o">=</span> <span class="n">block_mask</span><span class="p">;</span><span class="c1">//block all signal inside signal handler.</span>
</span><span class='line'><span class="o">+</span>       <span class="n">usr_action</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="n">SA_NODEFER</span><span class="p">;</span><span class="c1">//do not block SIGUSR1 within sig_handler_int.</span>
</span><span class='line'><span class="o">+</span>       <span class="n">sigaction</span> <span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usr_action</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>
</span><span class='line'><span class="o">+</span>       <span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event_sem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>       <span class="k">while</span><span class="p">(</span><span class="n">intrested_event</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'><span class="o">+</span>               <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event_sem</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>               <span class="k">if</span> <span class="p">(</span><span class="n">intrested_event</span><span class="p">){</span>
</span><span class='line'><span class="o">+</span>                       <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s,%d, received intrested_event signal.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>               <span class="p">}</span>
</span><span class='line'><span class="o">+</span>       <span class="p">}</span>
</span><span class='line'><span class="o">+</span>       <span class="n">intrested_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="n">shmdt</span><span class="p">(</span><span class="n">share_mem</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>       <span class="n">shmctl</span><span class="p">(</span><span class="n">share_mem_id</span><span class="p">,</span> <span class="n">IPC_RMID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">receiver_process</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="o">+</span>    <span class="n">wait_for_signal</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>In sender process, acquire the receiver process&#8217;spid through the share memory object, then send the signal.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span>  <span class="o">&lt;</span><span class="n">signal</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span>  <span class="o">&lt;</span><span class="n">sys</span><span class="o">/</span><span class="n">ipc</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">include</span>  <span class="o">&lt;</span><span class="n">sys</span><span class="o">/</span><span class="n">shm</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">+</span><span class="err">#</span><span class="n">define</span> <span class="n">MY_IPC_KEY_PATH</span> <span class="s">&quot;/data/misc/bluedroid&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="o">+</span><span class="k">static</span> <span class="kt">void</span> <span class="n">wakeup_receiver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="o">+</span><span class="p">{</span>
</span><span class='line'><span class="o">+</span>       <span class="n">key_t</span> <span class="n">my_ipc_key</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="kt">int</span> <span class="n">share_mem_id</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="n">pid_t</span> <span class="o">*</span><span class="n">share_mem</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>
</span><span class='line'><span class="o">+</span>       <span class="n">my_ipc_key</span>   <span class="o">=</span> <span class="n">ftok</span><span class="p">(</span><span class="n">MY_IPC_KEY_PATH</span><span class="p">,</span> <span class="sc">&#39;s&#39;</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>       <span class="n">share_mem_id</span>   <span class="o">=</span> <span class="n">shmget</span><span class="p">(</span><span class="n">my_ipc_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pid_t</span><span class="p">),</span> <span class="mo">0666</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>       <span class="n">share_mem</span>  <span class="o">=</span> <span class="p">(</span><span class="n">pid_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">shmat</span><span class="p">(</span><span class="n">share_mem_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>       <span class="n">pid</span>     <span class="o">=</span> <span class="o">*</span><span class="n">share_mem</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span>       <span class="n">shmdt</span><span class="p">(</span><span class="n">share_mem</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>
</span><span class='line'><span class="o">+</span>       <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'><span class="o">+</span>               <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">sigquue</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">SIGINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">){</span>
</span><span class='line'>                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;send signal failed %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span><span class='line'>                        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'><span class="o">+</span>               <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s,%d, send signale to pid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>       <span class="p">}</span>
</span><span class='line'><span class="o">+</span>       <span class="k">else</span><span class="p">{</span>
</span><span class='line'><span class="o">+</span>               <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s,%d, pid %d not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span><span class='line'><span class="o">+</span>       <span class="p">}</span>
</span><span class='line'><span class="o">+</span>
</span><span class='line'><span class="o">+</span><span class="p">}</span>
</span><span class='line'><span class="kt">void</span> <span class="n">sender</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="o">+</span>    <span class="n">wakeup_receiver</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A note: shmget() is not available in Android, so this is not a valid IPC for Android.</p>

<p>Reference:</p>

<blockquote><p></p><footer><strong>http://www.csl.mtu.edu/cs4411.ck/www/NOTES/signal/kill.html</strong></footer></blockquote>


<h2>Footnote: signal lost</h2>

<p>1 unreliable signal:
earlier version of UNIX signal is unreliable</p>

<blockquote><p></p><footer><strong>unreliable signals</strong> <cite><a href='http://codeidol.com/community/nix/unreliable-signals/5031'>codeidol.com/community/nix/5031/&hellip;</a></cite></footer></blockquote>


<p>2 real-time signal:</p>

<blockquote><p></p><footer><strong>man page</strong> <cite><a href='http://man7.org/linux/man-pages/man7/signal.7.html'>man7.org/linux/man-pages/man7/&hellip;</a></cite></footer></blockquote>


<p>POSIX added signals, and <blockquote><p></p><footer><strong>why signal is a bad AIO than poll</strong> <cite><a href='http://stackoverflow.com/questions/6345973/who-uses-posix-realtime-signals-and-why'>stackoverflow.com/questions/&hellip;</a></cite></footer></blockquote>
3 signal lost:</p>

<p><em>. when signal handler is running, blocked signals is &#8220;lost&#8221; (?!)
</em>. when signal handler is running, the same signal is blocked by default, add SA_NODEFER in sigaction.sa_flags unblock it. <blockquote><p></p><footer><strong>man page</strong> <cite><a href='http://man7.org/linux/man-pages/man2/sigaction.2.html'>man7.org/linux/man-pages/man2/&hellip;</a></cite></footer></blockquote></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
        <h1 class="entry-title"><a href="/blog/2013/03/11/resource-leakage-in-android-java-apk/">Resource Leakage in Android Java Apk</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-03-11T02:12:00-07:00" pubdate data-updated="true">Mar 11<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/03/11/resource-leakage-in-android-java-apk/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Bug: Keep on resetting BT adapter cause Android crash</strong></p>

<p>Bug description: In GTV/Honeycomb&#8217;s System Setting UI, keep on turning on/off Bluetooth for about 270 times, Android will crash, and UI restart from blackscreen.</p>

<p>My analyze:
First thing is to located where Android system crashed from logcat, there must be something related to zygote, then I found this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>03-08 20:15:00.026 I/Zygote  ( 3749): Exit zygote because system server (3780) has terminated</span></code></pre></td></tr></table></div></figure>


<p>Above that I found a fatal error message:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>03-08 20:14:59.226 F/Looper  ( 3780): Could not create wake pipe.  errno=24</span></code></pre></td></tr></table></div></figure>


<p>then all system service died like below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>03-08 20:14:59.316 I/ServiceManager(  690): service 'usagestats' died</span></code></pre></td></tr></table></div></figure>


<p>Tracing down the fatal error message in Android XRef, the error occurs when creating a new Looper instance, in Honeycomb/frameworks/base/libs/utils/Looper.cpp, where 3 new pips need to be created for one new Looper object.
So I guess the isssue is kind of file/socket/pipe handle leakage issue, to verify this, compare &#8220;lsof&#8221; result after turn on/off Bluetooth once, I can see there&#8217;s 3 newly opened pipes in system_service everytime I performed a turn on/off Bluetooth. Then I found from website that someone reported similar issue on <a href="https://code.google.com/p/android/issues/detail?id=24414" title="Android Bug List">Android Bug List</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/ # lsof |grep system_se >/data/debug/after_turn_off_bt.txt
</span><span class='line'>/ # hciconfig hci0 up; sleep 5; hciconfig hci0 down
</span><span class='line'>/ # lsof |grep system_se >/data/debug/after_turn_off_bt_again.txt
</span><span class='line'>/ # busybox diff  /data/debug/after_turn_off_bt.txt /data/debug/after_turn_off_bt_again.txt
</span><span class='line'> system_se   887        ???  224       ???                ???       ???        ??? /dev/null
</span><span class='line'>+system_se   887        ???  225       ???                ???       ???        ??? pipe:[7641]
</span><span class='line'>+system_se   887        ???  227       ???                ???       ???        ??? pipe:[7641]
</span><span class='line'>+system_se   887        ???  228       ???                ???       ???        ??? anon_inode:[eventpoll]</span></code></pre></td></tr></table></div></figure>


<p>The symptom is quite clear now, but how to locate leakage position in Android?</p>

<p>The first clue is that Looper object is used for Android Handler object, it&#8217;s hard to dump call stack in Android native C++ service, but it&#8217;s easy to do that in Java.
So I added a dump stack in Handler&#8217;s construction method, caught below message when I turn on Bluetooth:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>03-11 05:14:07.806 D/Handler (  898):android.os.Handler
</span><span class='line'>03-11 05:14:07.806 D/Handler (  898):com.android.internal.util.HierarchicalStateMachine$HsmHandler
</span><span class='line'>03-11 05:14:07.806 D/Handler (  898):com.android.internal.util.HierarchicalStateMachine$HsmHandler
</span><span class='line'>03-11 05:14:07.806 D/Handler (  898):com.android.internal.util.HierarchicalStateMachine
</span><span class='line'>03-11 05:14:07.806 D/Handler (  898):com.android.internal.util.HierarchicalStateMachine
</span><span class='line'>03-11 05:14:07.806 D/Handler (  898):android.bluetooth.BluetoothDeviceProfileState
</span><span class='line'>03-11 05:14:07.806 D/Handler (  898):android.server.BluetoothService
</span><span class='line'>03-11 05:14:07.806 D/Handler (  898):android.server.BluetoothService
</span><span class='line'>03-11 05:14:07.806 D/Handler (  898):android.server.BluetoothService
</span><span class='line'>03-11 05:14:07.806 D/Handler (  898):android.server.BluetoothService$EnableThread</span></code></pre></td></tr></table></div></figure>


<p>After doing some source code search, I reached the place in BluetoothService.java when problem occurs:
When turn off BT, BluetoothService will do:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">2146</span>     <span class="kt">void</span> <span class="n">removeProfileState</span><span class="o">(</span><span class="n">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="mi">2147</span>         <span class="n">mDeviceProfileState</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">address</span><span class="o">);</span> <span class="c1">//Comment out this line so BluetoothService will not create a new BluetoothDeviceProfileState every time BT reset.</span>
</span><span class='line'><span class="mi">2148</span>     <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then when turn on BT again, it will do:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">2136</span>     <span class="n">BluetoothDeviceProfileState</span> <span class="n">addProfileState</span><span class="o">(</span><span class="n">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="mi">2137</span>         <span class="n">BluetoothDeviceProfileState</span> <span class="n">state</span> <span class="o">=</span> <span class="n">mDeviceProfileState</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
</span><span class='line'><span class="mi">2138</span>         <span class="k">if</span> <span class="o">(</span><span class="n">state</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="n">state</span><span class="o">;</span>
</span><span class='line'><span class="mi">2140</span>         <span class="n">state</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BluetoothDeviceProfileState</span><span class="o">(</span><span class="n">mContext</span><span class="o">,</span> <span class="n">address</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">mA2dpService</span><span class="o">);</span>
</span><span class='line'><span class="mi">2144</span>     <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Problem here is, we only need do a reset when turn off BT, then we can reuse the BluetoothDeviceProfileState object after we turn it on again, but Android removed it instead, then need to create a new BluetoothDeviceProfileState object next time. If we did not remove the object every time we turn off BT, then the issue disappeared.</p>

<p><em>My comments:</em>
For Java class who claims system resource in its construction method, we must declare corresponding interface to release them, GC can not do this job for us.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/04/09/verify-the-signature-of-a-x-dot-509-certificate/">Verify the signature of a X.509 certificate</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/27/create-my-own-repo-to-manage-bundle-of-git-repositories/">create my own repo to manage bundle of git repositories</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/27/config-gerrit-server-behind-apache-https-reverse-proxy/">config gerrit server behind Apache https reverse-proxy</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/31/decode-instruction-address-in-oops-to-c-code-file-line/">decode instruction address in OOPS to C code file:line</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/24/atomic-file-write/">atomic file writing</a>
      </li>
    
  </ul>
</section>
<section>
        <h1>Categories</h1>
        <ul id="categories">
                <li class='category'><a href='/blog/categories/android/'>Android (8)</a></li>
<li class='category'><a href='/blog/categories/bluetooth/'>Bluetooth (9)</a></li>
<li class='category'><a href='/blog/categories/gerrit/'>gerrit (2)</a></li>
<li class='category'><a href='/blog/categories/linux/'>linux (6)</a></li>
<li class='category'><a href='/blog/categories/security/'>security (1)</a></li>

        </ul>
</section>






  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Yongbing Chen -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'yongbingchengithub';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
